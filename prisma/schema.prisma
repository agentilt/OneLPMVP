generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String             @id @default(cuid())
  email                  String             @unique
  name                   String?
  firstName              String?
  lastName               String?
  password               String
  role                   Role               @default(USER)
  emailVerified          DateTime?
  resetToken             String?
  resetTokenExpiry       DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  lastLoginAt            DateTime?
  lockedUntil            DateTime?
  loginAttempts          Int                @default(0)
  mfaEnabled             Boolean            @default(false)
  clientId               String?
  privacyAcceptedAt      DateTime?
  termsAcceptedAt        DateTime?
  websiteTermsAcceptedAt DateTime?
  emailWeeklyReports     Boolean            @default(false)
  emailMonthlyReports    Boolean            @default(false)
  activityEvents         ActivityEvent[]
  AuditLog               AuditLog[]
  directInvestments      DirectInvestment[]
  funds                  Fund[]
  fundAccess             FundAccess[]
  invitationsSent        Invitation[]
  mfaSettings            MFASettings?
  mfaTokens              MFAToken[]
  passwordResets         PasswordReset[]
  portfolioModels        PortfolioModel[]
  riskPolicy             RiskPolicy?
  riskScenarios          RiskScenario[]
  riskSnapshots          RiskSnapshot[]
  savedForecasts         SavedForecast[]
  savedReports           SavedReport[]
  securityEvents         SecurityEvent[]
  client                 Client?            @relation(fields: [clientId], references: [id])
  sessions               UserSession[]

  @@index([email])
  @@index([resetToken])
  @@index([mfaEnabled])
  @@index([lastLoginAt])
  @@index([lockedUntil])
  @@index([clientId])
}

model Invitation {
  id        String    @id @default(cuid())
  email     String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  invitedBy String
  role      String    @default("USER")
  tokenHash String?
  used      Boolean   @default(false)
  clientId  String?
  client    Client?   @relation(fields: [clientId], references: [id])
  creator   User      @relation(fields: [invitedBy], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([tokenHash])
  @@index([email])
  @@index([role])
  @@index([invitedBy])
  @@index([clientId])
}

model Client {
  id                String             @id @default(cuid())
  name              String
  email             String?
  phone             String?
  address           String?
  notes             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  directInvestments DirectInvestment[]
  funds             Fund[]
  invitations       Invitation[]
  riskSnapshots     RiskSnapshot[]
  users             User[]

  @@index([name])
  @@index([email])
}

model Fund {
  id              String            @id @default(cuid())
  userId          String?
  name            String
  domicile        String
  vintage         Int
  manager         String
  commitment      Float
  paidIn          Float
  nav             Float
  irr             Float
  tvpi            Float
  dpi             Float
  lastReportDate  DateTime
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  managerEmail    String?
  managerPhone    String?
  managerWebsite  String?
  clientId        String?
  capTableChanges String?
  highlights      String?
  lowlights       String?
  milestones      String?
  period          String?
  periodDate      DateTime?
  recentRounds    String?
  assetClass      String            @default("Multi-Strategy")
  strategy        String            @default("Generalist")
  sector          String?
  baseCurrency    String            @default("USD")
  leverage        Float             @default(0)
  preferredReturn Float             @default(0.08)
  distributions   Distribution[]
  documents       Document[]
  client          Client?           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user            User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  fundAccess      FundAccess[]
  navHistory      NavHistory[]
  aiDocumentChunks document_chunks[] @relation("FundAIChunks")
  aiDocuments      documents[]       @relation("FundAIDocuments")

  @@index([name])
  @@index([userId])
  @@index([clientId])
  @@index([assetClass])
  @@index([strategy])
}

model NavHistory {
  id        String   @id @default(cuid())
  fundId    String
  date      DateTime
  nav       Float
  createdAt DateTime @default(now())
  fund      Fund     @relation(fields: [fundId], references: [id], onDelete: Cascade)

  @@index([fundId, date])
}

model Distribution {
  id               String   @id @default(cuid())
  fundId           String
  distributionDate DateTime
  amount           Float
  distributionType String   @default("CASH")
  description      String?
  taxYear          Int?
  k1Status         String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  fund             Fund     @relation(fields: [fundId], references: [id], onDelete: Cascade)

  @@index([fundId])
  @@index([distributionDate])
}

model Document {
  id              String         @id @default(cuid())
  fundId          String
  type            DocumentType
  title           String
  uploadDate      DateTime
  dueDate         DateTime?
  callAmount      Float?
  paymentStatus   PaymentStatus?
  url             String
  parsedData      Json?
  investmentValue Float?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  fund            Fund           @relation(fields: [fundId], references: [id], onDelete: Cascade)

  @@index([fundId])
  @@index([type])
}

model FundAccess {
  id               String   @id @default(cuid())
  userId           String
  fundId           String
  createdAt        DateTime @default(now())
  relationshipType String?
  permissionLevel  String?  @default("READ_ONLY")
  notes            String?
  fund             Fund     @relation(fields: [fundId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fundId])
  @@index([userId])
  @@index([fundId])
  @@index([relationshipType])
}

model DirectInvestment {
  id                 String                     @id @default(cuid())
  userId             String?
  clientId           String?
  name               String
  industry           String?
  stage              String?
  investmentDate     DateTime?
  investmentAmount   Float?
  period             String?
  periodDate         DateTime?
  highlights         String?
  lowlights          String?
  milestones         String?
  recentRounds       String?
  capTableChanges    String?
  revenue            Float?
  arr                Float?
  mrr                Float?
  grossMargin        Float?
  runRate            Float?
  burn               Float?
  runway             Float?
  headcount          Int?
  cac                Float?
  ltv                Float?
  nrr                Float?
  cashBalance        Float?
  lastReportDate     DateTime?
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  couponRate         Float?
  creditRating       String?
  currentPrice       Float?
  currentValue       Float?
  defaultStatus      String?
  dividends          Float?
  interestRate       Float?
  investmentType     DirectInvestmentType       @default(PRIVATE_EQUITY)
  marketValue        Float?
  maturityDate       DateTime?
  principalAmount    Float?
  purchasePrice      Float?
  shares             Float?
  tickerSymbol       String?
  yield              Float?
  accountName        String?
  accountType        String?
  balance            Float?
  cashInterestRate   Float?
  cashMaturityDate   DateTime?
  currency           String?
  currentAppraisal   Float?
  maintenanceCost    Float?
  netOperatingIncome Float?
  occupancyRate      Float?
  propertyAddress    String?
  propertyTax        Float?
  propertyType       String?
  purchaseDate       DateTime?
  purchaseValue      Float?
  rentalIncome       Float?
  squareFootage      Float?
  acquisitionDate    DateTime?
  acquisitionValue   Float?
  assetCurrentValue  Float?
  assetDescription   String?
  assetIncome        Float?
  assetLocation      String?
  assetType          String?
  holdingCost        Float?
  client             Client?                    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user               User?                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents          DirectInvestmentDocument[]

  @@index([name])
  @@index([userId])
  @@index([clientId])
  @@index([industry])
  @@index([stage])
  @@index([investmentType])
  @@index([tickerSymbol])
}

model DirectInvestmentDocument {
  id                 String                       @id @default(cuid())
  directInvestmentId String
  type               DirectInvestmentDocumentType
  title              String
  uploadDate         DateTime
  dueDate            DateTime?
  url                String
  parsedData         Json?
  createdAt          DateTime                     @default(now())
  updatedAt          DateTime                     @updatedAt
  period             String?
  periodDate         DateTime?
  highlights         String?
  lowlights          String?
  milestones         String?
  recentRounds       String?
  capTableChanges    String?
  revenue            Float?
  arr                Float?
  mrr                Float?
  grossMargin        Float?
  runRate            Float?
  burn               Float?
  runway             Float?
  headcount          Int?
  cac                Float?
  ltv                Float?
  nrr                Float?
  cashBalance        Float?
  couponRate         Float?
  creditRating       String?
  currentPrice       Float?
  currentValue       Float?
  defaultStatus      String?
  dividends          Float?
  interestRate       Float?
  marketValue        Float?
  maturityDate       DateTime?
  principalAmount    Float?
  purchasePrice      Float?
  shares             Float?
  tickerSymbol       String?
  yield              Float?
  accountName        String?
  accountType        String?
  balance            Float?
  cashInterestRate   Float?
  cashMaturityDate   DateTime?
  currency           String?
  currentAppraisal   Float?
  maintenanceCost    Float?
  netOperatingIncome Float?
  occupancyRate      Float?
  propertyAddress    String?
  propertyTax        Float?
  propertyType       String?
  purchaseDate       DateTime?
  purchaseValue      Float?
  rentalIncome       Float?
  squareFootage      Float?
  acquisitionDate    DateTime?
  acquisitionValue   Float?
  assetCurrentValue  Float?
  assetDescription   String?
  assetIncome        Float?
  assetLocation      String?
  assetType          String?
  holdingCost        Float?
  directInvestment   DirectInvestment             @relation(fields: [directInvestmentId], references: [id], onDelete: Cascade)

  @@index([directInvestmentId])
  @@index([type])
  @@index([uploadDate])
}

model AuditLog {
  id          String        @id @default(cuid())
  userId      String
  action      AuditAction
  resource    AuditResource
  resourceId  String?
  description String
  oldValues   Json?
  newValues   Json?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime      @default(now())
  User        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([action])
  @@index([createdAt])
  @@index([resource])
  @@index([userId, createdAt])
  @@index([userId])
}

model invitations {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  token      String    @unique @db.VarChar(255)
  email      String    @db.VarChar(255)
  expires_at DateTime  @db.Timestamptz(6)
  used_at    DateTime? @db.Timestamptz(6)
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@index([token], map: "idx_invitations_token")
}

model users {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String    @unique @db.VarChar(255)
  password_hash String    @db.VarChar(255)
  first_name    String?   @db.VarChar(100)
  last_name     String?   @db.VarChar(100)
  name          String?   @db.VarChar(200)
  role          String?   @default("USER") @db.VarChar(50)
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  updated_at    DateTime? @default(now()) @db.Timestamptz(6)

  @@index([email], map: "idx_users_email")
}

model PasswordReset {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model MFAToken {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model MFASettings {
  id          String    @id @default(cuid())
  userId      String    @unique
  enabled     Boolean   @default(false)
  secret      String?
  backupCodes String[]
  lastUsed    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserSession {
  id              String    @id @default(cuid())
  userId          String
  sessionToken    String
  deviceInfo      Json?
  ipAddress       String?
  userAgent       String?
  lastActivity    DateTime
  expiresAt       DateTime
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  actionsCount    Int       @default(0)
  durationMinutes Int?
  endedAt         DateTime?
  pageViews       Int       @default(0)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([expiresAt])
  @@index([createdAt])
  @@index([isActive])
}

model SecurityEvent {
  id          String   @id @default(cuid())
  userId      String?
  eventType   String
  description String
  ipAddress   String?
  userAgent   String?
  metadata    Json?
  severity    String   @default("INFO")
  createdAt   DateTime @default(now())
  user        User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@index([severity])
}

model ActivityEvent {
  id           String   @id @default(cuid())
  userId       String
  eventType    String
  route        String?
  resourceId   String?
  resourceType String?
  action       String?
  element      String?
  metadata     Json?
  sessionId    String?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([eventType])
  @@index([route])
  @@index([resourceType])
  @@index([sessionId])
  @@index([createdAt])
}

model SavedReport {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  config      Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model SavedForecast {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  config      Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model RiskPolicy {
  id                          String   @id @default(cuid())
  userId                      String   @unique
  maxSingleFundExposure       Float    @default(25)
  maxGeographyExposure        Float    @default(40)
  maxSectorExposure           Float    @default(35)
  maxVintageExposure          Float    @default(30)
  maxManagerExposure          Float    @default(20)
  maxUnfundedCommitments      Float    @default(50)
  minLiquidityReserve         Float    @default(10)
  minNumberOfFunds            Int      @default(5)
  targetDiversificationScore  Float    @default(0.7)
  minAcceptableTVPI           Float    @default(1.5)
  minAcceptableDPI            Float    @default(0.5)
  minAcceptableIRR            Float    @default(10)
  maxCurrencyExposure         Float    @default(30)
  maxLeverageRatio            Float    @default(2.0)
  enablePolicyViolationAlerts Boolean  @default(true)
  enablePerformanceAlerts     Boolean  @default(true)
  enableLiquidityAlerts       Boolean  @default(true)
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt
  maxAssetClassExposure       Float    @default(35)
  minLiquidityCoverage        Float    @default(1.5)
  targetLiquidityBuffer       Float    @default(0.15)
  maxPortfolioLeverage        Float    @default(0.5)
  user                        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model RiskScenario {
  id                     String   @id @default(cuid())
  userId                 String
  name                   String
  description            String?
  navShock               Float
  callMultiplier         Float
  distributionMultiplier Float
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model RiskSnapshot {
  id                     String   @id @default(cuid())
  userId                 String
  clientId               String?
  snapshotDate           DateTime @default(now())
  overallRiskScore       Float
  concentrationRiskScore Float
  liquidityRiskScore     Float
  totalPortfolio         Float
  unfundedCommitments    Float
  liquidityCoverage      Float
  concentrationByAsset   Json
  concentrationByGeo     Json
  policyBreaches         Json
  createdAt              DateTime @default(now())
  client                 Client?  @relation(fields: [clientId], references: [id])
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, snapshotDate])
  @@index([snapshotDate])
}

model PortfolioModel {
  id        String   @id @default(cuid())
  userId    String
  name      String
  targets   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model document_chunks {
  id           String                 @id
  document_id  String
  fund_id      String?
  strategy_id  String?
  chunk_index  Int?
  slide_number Int?
  start_offset Int?
  end_offset   Int?
  text         String?
  embedding    Unsupported("vector(768)")?
  created_at   DateTime?              @default(now())
  aiDocument   documents              @relation("DocChunks", fields: [document_id], references: [id], onDelete: Cascade)
  Fund         Fund?                  @relation("FundAIChunks", fields: [fund_id], references: [id], onDelete: SetNull)

  @@index([embedding])
  @@index([fund_id])
}

model documents {
  id               String            @id
  fund_id          String?
  strategy_id      String?
  file_id          String?
  title            String
  doc_type         String?
  as_of_date       DateTime?
  uploaded_at      DateTime?         @default(now())
  source_system    String?
  page_count       Int?
  is_redacted      Boolean?          @default(false)
  aiDocumentChunks document_chunks[] @relation("DocChunks")
  Fund             Fund?             @relation("FundAIDocuments", fields: [fund_id], references: [id], onDelete: SetNull)

  @@index([doc_type])
  @@index([fund_id])
  @@index([uploaded_at])
}

enum Role {
  USER
  ADMIN
  DATA_MANAGER
}

enum DocumentType {
  CAPITAL_CALL
  QUARTERLY_REPORT
  ANNUAL_REPORT
  KYC
  COMPLIANCE
  OTHER
}

enum DirectInvestmentType {
  PRIVATE_EQUITY
  PRIVATE_DEBT
  PRIVATE_CREDIT
  PUBLIC_EQUITY
  REAL_ASSETS
  CASH
  REAL_ESTATE
}

enum DirectInvestmentDocumentType {
  EXECUTIVE_SUMMARY
  FINANCIAL_STATEMENT
  INVESTOR_UPDATE
  BOARD_PACKAGE
  CAP_TABLE
  TERM_SHEET
  OTHER
}

enum PaymentStatus {
  PENDING
  PAID
  LATE
  OVERDUE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  UPLOAD
  DOWNLOAD
  EXPORT
  IMPORT
  RESET_PASSWORD
  CHANGE_PASSWORD
  GRANT_ACCESS
  REVOKE_ACCESS
  VIEW
  SEARCH
  FILTER
  SORT
  EXPORT_DATA
  PRINT
  SHARE
  COPY
  NAVIGATE
  FORM_SUBMIT
  SETTINGS_UPDATE
  EMAIL_PREFERENCE_UPDATE
}

enum AuditResource {
  USER
  FUND
  DOCUMENT
  DIRECT_INVESTMENT
  DIRECT_INVESTMENT_DOCUMENT
  FUND_ACCESS
  INVITATION
  SYSTEM
  DASHBOARD
  SETTINGS
  AUDIT_LOG
  ANALYTICS
  PAGE
}
